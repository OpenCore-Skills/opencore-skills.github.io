<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCORE-Skills Catalog</title>
    <style>
        /* General Style */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f6f8fa;
            color: #24292e;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            border-bottom: 1px solid #e1e4e8;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        header h1 {
            margin: 0;
            color: #0366d6;
        }
        header p {
            margin: 5px 0 0;
            font-size: 1.1em;
            color: #586069;
        }

        /* Tool Sections Layout */
        .tool-section {
            margin-bottom: 25px;
        }

        /* Tool 1: Main Search (3-column) */
        #tool-1-search {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        /* Tool 2: Checklists (3-column) */
        #tool-2-checklists {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        /* Tool 3: Description (1-column, full-width) */
        #tool-3-description {
            /* No grid needed, it will be 100% width by default */
        }
        
        .search-group {
            display: flex;
            flex-direction: column;
        }
        .search-group label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .search-group input {
            padding: 10px;
            font-size: 1em;
            border: 1px solid #d1d5da;
            border-radius: 6px;
        }

        /* Checklist Styles */
        .checklist-group h3 {
            margin: 0 0 8px;
            font-weight: 600;
            font-size: 1em;
            color: #586069;
        }
        .tag-checklist {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background-color: #fff;
            border: 1px solid #d1d5da;
            padding: 10px;
            border-radius: 6px;
            min-height: 40px;
            max-height: 150px;
            overflow-y: auto;
        }
        .check-tag {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            background-color: #f6f8fa;
            color: #444;
            border: 1px solid #d1d5da;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
        }
        .check-tag.selected {
            background-color: #0366d6;
            color: #fff;
            border-color: #0366d6;
        }
        .check-tag:hover {
            opacity: 0.8;
        }

        /* Skill List */
        #skill-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            /* Set a minimum height to prevent layout jump */
            min-height: 500px; 
        }
        .skill-card {
            background-color: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 20px;
            transition: box-shadow 0.2s;
        }
        .skill-card:hover {
            box-shadow: 0 3px 6px rgba(149,157,165,0.2);
        }
        .skill-card h3 {
            margin: 0 0 10px;
        }
        .skill-card h3 a {
            font-family: Consolas, "Courier New", monospace;
            color: #0366d6;
            text-decoration: none;
            font-weight: 600;
        }
        .skill-card h3 a:hover {
            text-decoration: underline;
        }
        .skill-card p {
            margin: 0 0 15px;
        }
        .skill-card .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .skill-card .domain-tags {
            margin-bottom: 8px;
        }
        .skill-card .tag {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .skill-card .tag-domain {
            background-color: #f0f8ff; /* Light Blue */
            color: #0366d6;
        }
        .skill-card .tag-mission {
            background-color: #f3f9f0; /* Light Green */
            color: #22863a;
        }
        .skill-card .tag:hover {
            cursor: pointer;
            opacity: 0.8;
            text-decoration: underline;
        }
        
        /* --- NEW: Pagination Styles --- */
        #pagination-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 30px;
            padding-bottom: 20px;
        }
        .page-btn {
            padding: 8px 14px;
            border: 1px solid #d1d5da;
            background-color: #fff;
            color: #0366d6;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
        }
        .page-btn:hover {
            background-color: #f6f8fa;
        }
        .page-btn.active {
            background-color: #0366d6;
            color: #fff;
            border-color: #0366d6;
            font-weight: 600;
        }
        /* --- End Pagination Styles --- */
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>OpenCORE-Skills</h1>
            <p>COllaborative REpository for Physical AI and Robotics Skills</p>
        </header>

        <section id="tool-1-search" class="tool-section">
            <div class="search-group">
                <label for="search-name">Search by Name</label>
                <input type="text" id="search-name" placeholder="e.g. 'pick, place'">
            </div>
            <div class="search-group">
                <label for="search-domain">Search by Domain Tag</label>
                <input type="text" id="search-domain" placeholder="e.g. 'manipulation, hri'">
            </div>
            <div class="search-group">
                <label for="search-mission">Search by Mission Tag</label>
                <input type="text" id="search-mission" placeholder="e.g. 'logistics'">
            </div>
        </section>

        <section id="tool-2-checklists" class="tool-section">
            <div class="checklist-group">
                <h3>Skill Name</h3>
                <div id="name-checklist" class="tag-checklist">
                    </div>
            </div>
            
            <div class="checklist-group">
                <h3>Domain Tags</h3>
                <div id="domain-checklist" class="tag-checklist">
                    </div>
            </div>
            <div class="checklist-group">
                <h3>Mission Tags</h3>
                <div id="mission-checklist" class="tag-checklist">
                    </div>
            </div>
        </section>

        <section id="tool-3-description" class="tool-section">
            <div class="search-group">
                <label for="search-description">Search in Description (all words must match)</label>
                <input type="text" id="search-description" placeholder="e.g. 'grasp object'">
            </div>
        </section>

        <main id="skill-list">
            </main>
        
        <nav id="pagination-controls"></nav>

    </div>

    <template id="skill-card-template">
        <article class="skill-card">
            <h3 class="skill-name"></h3> 
            <p class="skill-description"></p>
            <div class="tag-container domain-tags"></div>
            <div class="tag-container mission-tags"></div>
        </article>
    </template>


    <script>
        // --- 1. SKILL DATA ---
        // This is injected by your build.py script.
        const skills = {{ skills_json | safe }};

        // --- 3. GLOBAL STATE ---
        let allSkillNames = [];
        let allDomainTags = [];
        let allMissionTags = [];

        // --- NEW: Pagination State ---
        let currentPage = 1;
        const skillsPerPage = 10;


        // --- 4. RENDERING & FILTERING FUNCTIONS ---
        
        function renderSkills(skillsToRender) {
            const skillListContainer = document.getElementById('skill-list');
            const skillCardTemplate = document.getElementById('skill-card-template');
            skillListContainer.innerHTML = ''; 

            if (skillsToRender.length === 0) {
                skillListContainer.innerHTML = '<p>No skills found matching your criteria.</p>';
                return;
            }

            skillsToRender.forEach(skill => {
                const card = skillCardTemplate.content.cloneNode(true);
                
                const skillNameElement = card.querySelector('.skill-name');
                const skillLink = document.createElement('a');
                skillLink.href = `/${skill.name}.html`; 
                skillLink.textContent = skill.name;
                skillNameElement.appendChild(skillLink);

                card.querySelector('.skill-description').textContent = skill.description;

                const domainContainer = card.querySelector('.domain-tags');
                (skill.domain_tags || []).forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag tag-domain';
                    tagElement.textContent = tag;
                    tagElement.addEventListener('click', () => handleTagClick(tag, 'domain'));
                    domainContainer.appendChild(tagElement);
                });

                const missionContainer = card.querySelector('.mission-tags');
                (skill.mission_tags || []).forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag tag-mission';
                    tagElement.textContent = tag;
                    tagElement.addEventListener('click', () => handleTagClick(tag, 'mission'));
                    missionContainer.appendChild(tagElement);
                });

                skillListContainer.appendChild(card);
            });
        }

        /**
         * MODIFIED: Now handles pagination logic.
         * @param {object} options - Optional object, e.g., { filterChanged: true }
         */
        function filterAndRender(options = {}) {
            // NEW: If a filter changed, reset to page 1
            if (options.filterChanged) {
                currentPage = 1;
            }

            const searchNameInput = document.getElementById('search-name');
            const searchDescriptionInput = document.getElementById('search-description');
            const searchDomainInput = document.getElementById('search-domain');
            const searchMissionInput = document.getElementById('search-mission');

            const nameQueries = searchNameInput.value.split(',')
                .map(q => q.trim().toLowerCase()).filter(q => q.length > 0);
            
            const descriptionQueries = searchDescriptionInput.value.split(' ')
                .map(q => q.trim().toLowerCase()).filter(q => q.length > 0);
            
            const domainQueries = searchDomainInput.value.split(',')
                .map(q => q.trim().toLowerCase()).filter(q => q.length > 0);
            
            const missionQueries = searchMissionInput.value.split(',')
                .map(q => q.trim().toLowerCase()).filter(q => q.length > 0);

            const getLowerTags = (skill, tagType) => {
                return (skill[tagType] || []).map(t => t.toLowerCase());
            };

            // 1. Get the FULL filtered list
            const filteredSkills = skills.filter(skill => {
                const skillNameLower = skill.name.toLowerCase();
                const skillDescriptionLower = (skill.description || "").toLowerCase();
                const skillDomainTags = getLowerTags(skill, 'domain_tags');
                const skillMissionTags = getLowerTags(skill, 'mission_tags');

                const nameMatch = nameQueries.length === 0 || nameQueries.some(query =>
                    skillNameLower.includes(query)
                );
                
                const descriptionMatch = descriptionQueries.length === 0 || descriptionQueries.every(queryWord =>
                    skillDescriptionLower.includes(queryWord)
                );

                const domainMatch = domainQueries.length === 0 || domainQueries.every(queryTag =>
                    skillDomainTags.includes(queryTag)
                );

                const missionMatch = missionQueries.length === 0 || missionQueries.every(queryTag =>
                    skillMissionTags.includes(queryTag)
                );
                
                return nameMatch && descriptionMatch && domainMatch && missionMatch;
            });

            // --- NEW PAGINATION LOGIC ---
            
            // 2. Calculate total pages from the FULL filtered list
            const totalPages = Math.ceil(filteredSkills.length / skillsPerPage);

            // 3. Get the "slice" (10 items) for the current page
            const start = (currentPage - 1) * skillsPerPage;
            const end = start + skillsPerPage;
            const skillsForThisPage = filteredSkills.slice(start, end);

            // 4. Render just the 10 skills for this page
            renderSkills(skillsForThisPage);

            // 5. Render the page number buttons
            renderPagination(totalPages);
            // --- END NEW PAGINATION LOGIC ---
        }

        // --- 5. CHECKLIST FUNCTIONS ---
        
        function populateChecklists() {
            const nameChecklistContainer = document.getElementById('name-checklist');
            const domainChecklistContainer = document.getElementById('domain-checklist');
            const missionChecklistContainer = document.getElementById('mission-checklist');

            const nameSet = new Set(skills.map(s => s.name));
            const domainTagSet = new Set(skills.flatMap(s => s.domain_tags || []));
            const missionTagSet = new Set(skills.flatMap(s => s.mission_tags || []));
            
            allSkillNames = [...nameSet].sort();
            allDomainTags = [...domainTagSet].sort();
            allMissionTags = [...missionTagSet].sort();
            
            allSkillNames.forEach(name => {
                const tagEl = document.createElement('span');
                tagEl.className = 'check-tag';
                tagEl.textContent = name;
                tagEl.addEventListener('click', () => handleChecklistClick(tagEl, 'name'));
                nameChecklistContainer.appendChild(tagEl);
            });
            
            allDomainTags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'check-tag';
                tagEl.textContent = tag;
                tagEl.addEventListener('click', () => handleChecklistClick(tagEl, 'domain'));
                domainChecklistContainer.appendChild(tagEl);
            });
            
            allMissionTags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'check-tag';
                tagEl.textContent = tag;
                tagEl.addEventListener('click', () => handleChecklistClick(tagEl, 'mission'));
                missionChecklistContainer.appendChild(tagEl);
            });
        }
        
        function handleChecklistClick(tagElement, tagType) {
            tagElement.classList.toggle('selected');
            updateSearchFromChecklist(tagType);
        }

        function updateSearchFromChecklist(tagType) {
            let container, input;
            if (tagType === 'domain') {
                container = document.getElementById('domain-checklist');
                input = document.getElementById('search-domain');
            } else if (tagType === 'mission') {
                container = document.getElementById('mission-checklist');
                input = document.getElementById('search-mission');
            } else if (tagType === 'name') {
                container = document.getElementById('name-checklist');
                input = document.getElementById('search-name');
            } else {
                return;
            }
            
            const selectedTags = [...container.querySelectorAll('.check-tag.selected')]
                .map(tagEl => tagEl.textContent);
            
            input.value = selectedTags.join(', ');
            filterAndRender({ filterChanged: true }); // A filter changed
        }
        
        function updateChecklistFromSearch(tagType) {
            let container, input;
            if (tagType === 'domain') {
                container = document.getElementById('domain-checklist');
                input = document.getElementById('search-domain');
            } else if (tagType === 'mission') {
                container = document.getElementById('mission-checklist');
                input = document.getElementById('search-mission');
            } else if (tagType === 'name') {
                container = document.getElementById('name-checklist');
                input = document.getElementById('search-name');
            } else {
                return;
            }
            
            const queries = input.value.split(',')
                .map(q => q.trim().toLowerCase()).filter(q => q.length > 0);
            
            container.querySelectorAll('.check-tag').forEach(tagEl => {
                const tagText = tagEl.textContent.toLowerCase();
                let isSelected = false;
                if (tagType === 'name') {
                    isSelected = queries.some(q => tagText.includes(q));
                } else {
                    isSelected = queries.includes(tagText);
                }
                
                tagEl.classList.toggle('selected', isSelected);
            });
        }

        function handleTagClick(tagText, tagType) {
            let input = (tagType === 'domain') ? document.getElementById('search-domain') : document.getElementById('search-mission');
            
            const currentQueries = input.value.split(',')
                .map(q => q.trim().toLowerCase()).filter(q => q.length > 0);
            
            const newTag = tagText.toLowerCase();
            
            if (!currentQueries.includes(newTag)) {
                currentQueries.push(newTag);
            }
            
            input.value = currentQueries.join(', ');
            
            updateChecklistFromSearch(tagType);
            filterAndRender({ filterChanged: true }); // A filter changed
        }

        // --- 6. NEW: PAGINATION FUNCTIONS ---
        
        /**
         * Renders the page number buttons
         * @param {number} totalPages - The total number of pages
         */
        function renderPagination(totalPages) {
            const container = document.getElementById('pagination-controls');
            container.innerHTML = ''; // Clear old buttons

            // Only show buttons if there's more than one page
            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.className = 'page-btn';
                btn.textContent = i;
                if (i === currentPage) {
                    btn.classList.add('active');
                }
                // Add click handler to change page
                btn.addEventListener('click', () => handlePageClick(i));
                container.appendChild(btn);
            }
        }

        /**
         * Handles a click on a page number button
         * @param {number} pageNumber - The page to navigate to
         */
        function handlePageClick(pageNumber) {
            currentPage = pageNumber;
            filterAndRender({ filterChanged: false }); // Page changed, not filter
            // Scroll to the top of the skill list
            document.getElementById('skill-list').scrollIntoView({ behavior: 'smooth' });
        }

        // --- 7. EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- NEW: Sort skills alphabetically by name ---
            skills.sort((a, b) => a.name.localeCompare(b.name));

            // We need to get elements *after* the page has loaded
            const searchNameInput = document.getElementById('search-name');
            const searchDescriptionInput = document.getElementById('search-description');
            const searchDomainInput = document.getElementById('search-domain');
            const searchMissionInput = document.getElementById('search-mission');

            // 1. Populate the checklists
            populateChecklists();

            // 2. Check for URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const domainTagQuery = urlParams.get('domain_tag');
            const missionTagQuery = urlParams.get('mission_tag');

            if (domainTagQuery) {
                searchDomainInput.value = domainTagQuery;
                updateChecklistFromSearch('domain');
            }
            if (missionTagQuery) {
                searchMissionInput.value = missionTagQuery;
                updateChecklistFromSearch('mission');
            }

            // 3. Run the initial filter and render
            filterAndRender({ filterChanged: false }); // Initial load

            // 4. Add all event listeners
            searchNameInput.addEventListener('input', () => {
                updateChecklistFromSearch('name');
                filterAndRender({ filterChanged: true }); // A filter changed
            });
            
            searchDescriptionInput.addEventListener('input', () => {
                filterAndRender({ filterChanged: true }); // A filter changed
            });
            
            searchDomainInput.addEventListener('input', () => {
                updateChecklistFromSearch('domain');
                filterAndRender({ filterChanged: true }); // A filter changed
            });
            
            searchMissionInput.addEventListener('input', () => {
                updateChecklistFromSearch('mission');
                filterAndRender({ filterChanged: true }); // A filter changed
            });
        });

    </script>
</body>
</html>
