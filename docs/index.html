<!DOCTYPE html>
<template id="skill-card-template">
        <article class="skill-card">
            <h3 class="skill-name"></h3> 
            <p class="skill-description"></p>
            <div class="tag-container domain-tags"></div>
            <div class="tag-container mission-tags"></div>
        </article>
    </template>


    <script>
        // --- 1. SKILL DATA (Mockup) ---
        // DELETED: The hardcoded 'const skills = [...]' array is gone.
        
        // NEW: This line will be replaced by your build.py script.
        // The 'safe' filter in Jinja ensures the JSON is parsed correctly.
        const skills = {{ skills_json | safe }};

        // --- 2. DOM REFERENCES ---
        // (All the rest of the JavaScript is 100% IDENTICAL)
        const searchNameInput = document.getElementById('search-name');
        const searchDescriptionInput = document.getElementById('search-description');
        const searchDomainInput = document.getElementById('search-domain');
        const searchMissionInput = document.getElementById('search-mission');
        const skillListContainer = document.getElementById('skill-list');
        const skillCardTemplate = document.getElementById('skill-card-template');
        
        const nameChecklistContainer = document.getElementById('name-checklist');
        const domainChecklistContainer = document.getElementById('domain-checklist');
        const missionChecklistContainer = document.getElementById('mission-checklist');
        
        // --- 3. GLOBAL STATE (for checklists) ---
        let allSkillNames = [];
        let allDomainTags = [];
        let allMissionTags = [];

        // --- 4. RENDERING & FILTERING FUNCTIONS ---

        function renderSkills(skillsToRender) {
            skillListContainer.innerHTML = ''; 

            if (skillsToRender.length === 0) {
                skillListContainer.innerHTML = '<p>No skills found matching your criteria.</p>';
                return;
            }

            skillsToRender.forEach(skill => {
                const card = skillCardTemplate.content.cloneNode(true);
                
                const skillNameElement = card.querySelector('.skill-name');
                const skillLink = document.createElement('a');
                skillLink.href = `/${skill.name}.html`; 
                skillLink.textContent = skill.name;
                skillNameElement.appendChild(skillLink);

                card.querySelector('.skill-description').textContent = skill.description;

                const domainContainer = card.querySelector('.domain-tags');
                skill.domain_tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag tag-domain';
                    tagElement.textContent = tag;
                    tagElement.addEventListener('click', () => handleTagClick(tag, 'domain'));
                    domainContainer.appendChild(tagElement);
                });

                const missionContainer = card.querySelector('.mission-tags');
                skill.mission_tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag tag-mission';
                    tagElement.textContent = tag;
                    tagElement.addEventListener('click', () => handleTagClick(tag, 'mission'));
                    missionContainer.appendChild(tagElement);
                });

                skillListContainer.appendChild(card);
            });
        }

        function filterAndRender() {
            const nameQueries = searchNameInput.value.split(',')
                .map(q => q.trim().toLowerCase()).filter(q => q.length > 0);
            
            const descriptionQueries = searchDescriptionInput.value.split(' ')
                .map(q => q.trim().toLowerCase()).filter(q => q.length > 0);
            
            const domainQueries = searchDomainInput.value.split(',')
                .map(q => q.trim().toLowerCase()).filter(q => q.length > 0);
            
            const missionQueries = searchMissionInput.value.split(',')
                .map(q => q.trim().toLowerCase()).filter(q => q.length > 0);

            const getLowerTags = (skill, tagType) => {
                return (skill[tagType] || []).map(t => t.toLowerCase());
            };

            const filteredSkills = skills.filter(skill => {
                const skillNameLower = skill.name.toLowerCase();
                const skillDescriptionLower = skill.description.toLowerCase();
                const skillDomainTags = getLowerTags(skill, 'domain_tags');
                const skillMissionTags = getLowerTags(skill, 'mission_tags');

                const nameMatch = nameQueries.length === 0 || nameQueries.some(query =>
                    skillNameLower.includes(query)
                );
                
                const descriptionMatch = descriptionQueries.length === 0 || descriptionQueries.every(queryWord =>
                    skillDescriptionLower.includes(queryWord)
                );

                const domainMatch = domainQueries.length === 0 || domainQueries.every(queryTag =>
                    skillDomainTags.includes(queryTag)
                );

                const missionMatch = missionQueries.length === 0 || missionQueries.every(queryTag =>
                    skillMissionTags.includes(queryTag)
                );
                
                return nameMatch && descriptionMatch && domainMatch && missionMatch;
            });

            renderSkills(filteredSkills);
        }

        // --- 5. CHECKLIST FUNCTIONS ---

        function populateChecklists() {
            const nameSet = new Set(skills.map(s => s.name));
            const domainTagSet = new Set(skills.flatMap(s => s.domain_tags));
            const missionTagSet = new Set(skills.flatMap(s => s.mission_tags));
            
            allSkillNames = [...nameSet].sort();
            allDomainTags = [...domainTagSet].sort();
            allMissionTags = [...missionTagSet].sort();
            
            allSkillNames.forEach(name => {
                const tagEl = document.createElement('span');
                tagEl.className = 'check-tag';
                tagEl.textContent = name;
                tagEl.addEventListener('click', () => handleChecklistClick(tagEl, 'name'));
                nameChecklistContainer.appendChild(tagEl);
            });
            
            allDomainTags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'check-tag';
                tagEl.textContent = tag;
                tagEl.addEventListener('click', () => handleChecklistClick(tagEl, 'domain'));
                domainChecklistContainer.appendChild(tagEl);
            });
            
            allMissionTags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'check-tag';
                tagEl.textContent = tag;
                tagEl.addEventListener('click', () => handleChecklistClick(tagEl, 'mission'));
                missionChecklistContainer.appendChild(tagEl);
            });
        }
        
        function handleChecklistClick(tagElement, tagType) {
            tagElement.classList.toggle('selected');
            updateSearchFromChecklist(tagType);
        }

        function updateSearchFromChecklist(tagType) {
            let container, input;
            if (tagType === 'domain') {
                container = domainChecklistContainer;
                input = searchDomainInput;
            } else if (tagType === 'mission') {
                container = missionChecklistContainer;
                input = searchMissionInput;
            } else if (tagType === 'name') {
                container = nameChecklistContainer;
                input = searchNameInput;
            } else {
                return;
            }
            
            const selectedTags = [...container.querySelectorAll('.check-tag.selected')]
                .map(tagEl => tagEl.textContent);
            
            input.value = selectedTags.join(', ');
            filterAndRender();
        }
        
        function updateChecklistFromSearch(tagType) {
            let container, input;
            if (tagType === 'domain') {
                container = domainChecklistContainer;
                input = searchDomainInput;
            } else if (tagType === 'mission') {
                container = missionChecklistContainer;
                input = searchMissionInput;
            } else if (tagType === 'name') {
                container = nameChecklistContainer;
                input = searchNameInput;
            } else {
                return;
            }
            
            const queries = input.value.split(',')
                .map(q => q.trim().toLowerCase()).filter(q => q.length > 0);
            
            container.querySelectorAll('.check-tag').forEach(tagEl => {
                const tagText = tagEl.textContent.toLowerCase();
                let isSelected = false;
                if (tagType === 'name') {
                    isSelected = queries.some(q => tagText.includes(q));
                } else {
                    isSelected = queries.includes(tagText);
                }
                
                tagEl.classList.toggle('selected', isSelected);
            });
        }

        function handleTagClick(tagText, tagType) {
            let input = (tagType === 'domain') ? searchDomainInput : searchMissionInput;
            
            const currentQueries = input.value.split(',')
                .map(q => q.trim().toLowerCase()).filter(q => q.length > 0);
            
            const newTag = tagText.toLowerCase();
            
            if (!currentQueries.includes(newTag)) {
                currentQueries.push(newTag);
            }
            
            input.value = currentQueries.join(', ');
            
            updateChecklistFromSearch(tagType);
            filterAndRender();
        }

        // --- 6. EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            populateChecklists(); // This will now use the dynamically injected 'skills' list

            const urlParams = new URLSearchParams(window.location.search);
            const domainTagQuery = urlParams.get('domain_tag');
            const missionTagQuery = urlS.get('mission_tag');

            if (domainTagQuery) {
                searchDomainInput.value = domainTagQuery;
                updateChecklistFromSearch('domain');
            }
            if (missionTagQuery) {
                searchMissionInput.value = missionTagQuery;
                updateChecklistFromSearch('mission');
            }

            filterAndRender();
        });

        searchNameInput.addEventListener('input', () => {
            updateChecklistFromSearch('name');
            filterAndRender();
        });
        
        searchDescriptionInput.addEventListener('input', filterAndRender);
        
        searchDomainInput.addEventListener('input', () => {
            updateChecklistFromSearch('domain');
            filterAndRender();
        });
        
        searchMissionInput.addEventListener('input', () => {
            updateChecklistFromSearch('mission');
            filterAndRender();
        });

    </script>
</body>
</html>
